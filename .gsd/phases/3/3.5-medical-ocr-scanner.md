---
phase: 3
plan: 5
wave: 2
depends_on: [4]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "Images parse offline instantly without failing network boundaries."
    - "RegEx data captures prefill UI editors explicitly avoiding incorrect assignments securely generating `MedicalRecordModel` objects."
  artifacts:
    - "lib/presentation/screens/profile/medical_scanner_screen.dart"
---

# Plan 3.5: Medical Report OCR Scanner

<objective>
Bring in `google_mlkit_text_recognition` capturing physical report images asynchronously offline. Connect it via our `MedicalParserService` identifying numbers directly into editable form inputs saving it globally yielding Karma upon completion natively.

Purpose: Automate tedious medical record entry while digitizing vital health trends explicitly for the AI integration later.
Output: Real actionable arrays plotting inside UI explicitly.
</objective>

<context>
Load for context:
- fitkarma/pubspec.yaml (checking `google_mlkit_text_recognition` / `image_picker`)
- fitkarma/lib/domain/services/medical_parser_service.dart
- fitkarma/lib/data/providers/karma_provider.dart
</context>

<tasks>

<task type="auto">
  <name>Camera & Image Picker Pipeline</name>
  <files>lib/presentation/screens/profile/medical_scanner_screen.dart</files>
  <action>
    - Ensure `MedicalScannerScreen` accesses the device `image_picker` correctly (Camera vs Gallery prompts).
    - Handle native privacy permissions ensuring explicit fallbacks upon rejection.
    - Transform the returned file asynchronously passing it into a `TextRecognizer`.
  </action>
  <verify>Image selections do not block UI mapping paths securely resolving inputs.</verify>
  <done>User views their local image natively without errors prior to processing accurately.</done>
</task>

<task type="auto">
  <name>OCR Trigger & RegEx Integration</name>
  <files>lib/presentation/screens/profile/medical_scanner_screen.dart</files>
  <action>
    - Inject an `extractText()` function applying `TextRecognizer.processImage(InputImage.fromFilePath(path))` returning massive text arrays explicitly.
    - Funnel the explicit string directly inside `MedicalParserService.parseText(result.text)` outputting an explicit Map.
    - Present the mapped object inside an editable dialog allowing the user to correct misreads seamlessly visually verifying elements natively.
    - Map a "Save to Profile" action explicitly calling `SyncService` uploading records into the explicit `medical_records` Pocketbase collection securely triggering a `KarmaNotifier.earnKarma(25, 'Uploaded Report')`.
  </action>
  <verify>Completing the scan executes states saving explicitly avoiding data traps safely triggering notifications dynamically updating history.</verify>
  <done>Full completion natively updates background statistics providing valid tokens efficiently digitizing records magically offline.</done>
</task>

</tasks>

<verification>
After all tasks, verify:
- [ ] Karma triggers perfectly without duplicated logs cleanly pushing to `Pocketbase` creating accurate models mapping trends.
</verification>

<success_criteria>
- [ ] All tasks verified
- [ ] Must-haves confirmed
</success_criteria>
