---
phase: 3
plan: 4
wave: 1
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "A parser module converts arbitrary strings like 'Glucose: 100' into explicit key-value pairs reliably."
    - "Models representing Medical Records cache seamlessly mapping properties like `type` and `value` natively."
  artifacts:
    - "lib/data/models/medical_record_model.dart"
    - "lib/domain/services/medical_parser_service.dart"
---

# Plan 3.4: Medical Data & Expression Parsers

<objective>
Setup regex matching engines processing generalized text into normalized medical readings (HbA1c, BP, etc.) powering offline analytics securely mapping directly into new `MedicalRecordModel` objects.

Purpose: Provide foundational offline logic parsing strings cleanly without hitting cloud APIs costing money on MVP.
Output: Predictable models containing vital data from any random block of text accurately storing in Hive.
</objective>

<context>
Load for context:
- fitkarma/lib/core/storage/hive_service.dart
</context>

<tasks>

<task type="auto">
  <name>Construct Medical Record Entity</name>
  <files>lib/data/models/medical_record_model.dart</files>
  <action>
    - Ensure a `MedicalRecordModel` exists defining specific metric identifiers (`type: 'hba1c'`, `value: '5.6'`, `unit: '%'`, `date`, `id`).
    - Add Hive annotations (`@HiveType(typeId: 3)`) mapping logic natively.
    - Write explicit serialization/deserialization logic catching Pocketbase API structures accurately.
    - Generate `medical_record_model.g.dart` explicitly matching `build_runner`.
  </action>
  <verify>Generations succeed explicitly storing Medical Data accurately locally preventing overrides securely.</verify>
  <done>Record structures safely persist metrics tracking history dynamically.</done>
</task>

<task type="auto">
  <name>Build Regex Parsing Engine</name>
  <files>lib/domain/services/medical_parser_service.dart</files>
  <action>
    - Create `MedicalParserService` implementing a static `parseText(String input)` returning a `Map<String, String>` of normalized vitals.
    - Formulate explicit RegExp logic capturing formats:
      `HbA1[c]?\s*[:\-]?\s*(\d+\.?\d*)` -> `hba1c`
      `Blood\s*Pressure\s*[:\-]?\s*(\d{2,3})\s*[\/\\]\s*(\d{2,3})` -> `bp`
      `Cholesterol\s*[:\-]?\s*(\d+\.?\d*)` -> `cholesterol`
      `Glucose\s*[:\-]?\s*(\d+\.?\d*)` -> `glucose`
    - Add fallback `try-catch` protecting regex faults from crashing natively.
  </action>
  <verify>The parser flawlessly maps string input natively identifying random variations seamlessly parsing standard values.</verify>
  <done>Engine converts pure text matching native Indian reporting structures successfully.</done>
</task>

</tasks>

<verification>
After all tasks, verify:
- [ ] RegEx rules explicitly resolve varied textual formatting without failing capturing standard elements mapping arrays effectively defining key structures.
</verification>

<success_criteria>
- [ ] All tasks verified
- [ ] Must-haves confirmed
</success_criteria>
