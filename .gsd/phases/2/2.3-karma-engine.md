---
phase: 2
plan: 3
wave: 1
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "Karma transactions safely increment points modifying `UserModel`."
  artifacts:
    - "lib/data/providers/karma_provider.dart"
---

# Plan 2.3: Karma Reward Engine

<objective>
Implement the primary currency abstraction giving users Karma points triggering from multiple actions (steps, meals logged). Updates PocketBase profile balances synchronously via the `SyncService` local-first rule.

Purpose: Core psychological gamification loop (rewards usage).
Output: Functions capable of being called by UI `ref.read(karmaProvider.notifier).earnKarma(10, 'Logged Meal')`.
</objective>

<context>
Load for context:
- lib/data/models/user_model.dart
- lib/core/storage/hive_service.dart
- lib/core/sync/sync_service.dart
</context>

<tasks>

<task type="auto">
  <name>Karma State Notifier setup</name>
  <files>lib/data/providers/karma_provider.dart</files>
  <action>
    - Add `KarmaNotifier` mapping directly to the active `UserModel` from `AuthProvider`.
    - Provide an `earnKarma(amount, reason)` function checking current points, incrementing it immediately.
    - Write value locally to `HiveService.userBox`.
    - Queue `update` operation to `SyncService` targeting the `users` PocketBase record reflecting `karmaPoints`.
  </action>
  <verify>Calling earnKarma logs an item properly through the user provider caching.</verify>
  <done>User Model effectively saves to disk mimicking updated metrics instantly.</done>
</task>

</tasks>

<verification>
After all tasks, verify:
- [ ] Karma limits trigger safely updating local Hive states securely.
</verification>

<success_criteria>
- [ ] All tasks verified
- [ ] Must-haves confirmed
</success_criteria>
