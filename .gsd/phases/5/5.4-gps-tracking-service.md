---
phase: 5
plan: 4
wave: 3
depends_on: []
files_modified: [
  "fitkarma/lib/core/sync/location_service.dart",
  "fitkarma/lib/data/providers/activity_provider.dart",
  "fitkarma/lib/data/models/activity_model.dart"
]
autonomous: true

must_haves:
  truths:
    - "The app can request and handle background location permissions."
    - "A background stream tracks coordinates and calculates distance in real-time."
  artifacts:
    - "lib/core/sync/location_service.dart"
    - "lib/data/models/activity_model.dart"
---

# Plan 5.4: GPS Tracking Infrastructure

<objective>
Build the core GPS tracking engine allowing users to record outdoor walks, runs, and cycles with accurate distance and duration metrics.

Purpose: Expand the fitness logging capabilities beyond steps and manual entries.
Output: A robust location tracking service and activity data model.
</objective>

<context>
Load for context:
- fitkarma/pubspec.yaml (confirm geolocator)
- fitkarma/lib/data/models/user_model.dart
</context>

<tasks>

<task type="auto">
  <name>Define Activity Model & Storage</name>
  <files>lib/data/models/activity_model.dart, lib/data/models/activity_model.g.dart</files>
  <action>
    - Create `ActivityModel`: `id`, `type` (walk/run/cycle), `distanceMeter`, `durationSec`, `startTime`, `endTime`, `polylinePath` (List of [lat, lng]), and `calories`.
    - Generate Hive adapters for offline persistence.
  </action>
  <verify>Run build_runner and confirm `.g.dart` file exists.</verify>
  <done>Activity data is structured and cacheable.</done>
</task>

<task type="auto">
  <name>Develop Location Tracking Service</name>
  <files>lib/core/sync/location_service.dart, lib/data/providers/activity_provider.dart</files>
  <action>
    - Implement `LocationService` using `geolocator` with background tracking permission logic.
    - Create a stream that emits coordinate updates whenever significant movement occurs.
    - Implement distance calculation using `Geolocator.distanceBetween`.
    - Ensure background execution is handled (using `flutter_background_service` if needed, or keeping it active with a foreground notification). *Note: sticking to geolocator and keeping app active for MVP.*
  </action>
  <verify>Service returns real-time coordinate updates and cumulative distance.</verify>
  <done>App can capture live movement data.</done>
</task>

</tasks>

<verification>
After all tasks, verify:
- [ ] ActivityModel serializes correctly.
- [ ] LocationService requests permissions correctly.
- [ ] Coordinates are added to polyline stream during active tracking.
</verification>

<success_criteria>
- [ ] All tasks verified
- [ ] Must-haves confirmed
</success_criteria>
