---
phase: 5
plan: 5
wave: 3
depends_on: [4]
files_modified: [
  "fitkarma/lib/presentation/screens/home/activity_tracking_screen.dart",
  "fitkarma/lib/presentation/screens/home/dashboard_tab.dart"
]
autonomous: true

must_haves:
  truths:
    - "Users can see their live location and track on an OpenStreetMap."
    - "Tracked activities are saved locally and synced to PocketBase on completion."
  artifacts:
    - "lib/presentation/screens/home/activity_tracking_screen.dart"
---

# Plan 5.5: GPS Activity UI & Map Integration

<objective>
Provide a visual interface for GPS tracking, allowing users to interact with a live map and view their tracked paths.

Purpose: Provide immediate visual feedback for outdoor activities and finalize activity logging.
Output: Tracking screen with map rendering and activity summary.
</objective>

<context>
Load for context:
- fitkarma/pubspec.yaml (confirm flutter_map)
- .gsd/phases/5/5.4-gps-tracking-service.md
- fitkarma/lib/presentation/screens/home/dashboard_tab.dart (to add entry point)
</context>

<tasks>

<task type="auto">
  <name>Build Activity Tracking Screen</name>
  <files>lib/presentation/screens/home/activity_tracking_screen.dart</files>
  <action>
    - Integrate `flutter_map` with `openstreetmap` tiles.
    - Implement a full-screen map with a `PolylineLayer` to render the user's path.
    - Add real-time stats overlay: Duration, Distance (km), and Pace.
    - Add Start/Pause/Stop control buttons with confirmation logic.
  </action>
  <verify>Navigating to Activity screen shows a functional map with the user's location marker.</verify>
  <done>Users have a UI to track active outdoor sessions.</done>
</task>

<task type="auto">
  <name>Finalize Activity Summary & Sync</name>
  <files>lib/presentation/screens/home/activity_tracking_screen.dart</files>
  <action>
    - On 'Stop', show a summary dialog/view with final stats.
    - Save activity to `activity_logs` in PocketBase and award Karma points based on distance (e.g., +2 per km).
    - Add activity entry to the community feed automatically (optional, based on privacy settings).
  </action>
  <verify>Stopping an activity persists the record and shows the summary.</verify>
  <done>Activities are recorded, rewarded, and summarized.</done>
</task>

</tasks>

<verification>
After all tasks, verify:
- [ ] Map renders correctly with user location.
- [ ] Polyline connects coordinate points during tracking.
- [ ] Karma points are awarded upon session completion.
</verification>

<success_criteria>
- [ ] All tasks verified
- [ ] Must-haves confirmed
</success_criteria>
