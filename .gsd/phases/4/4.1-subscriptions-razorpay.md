---
phase: 4
plan: 1
wave: 1
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "Users can seamlessly initiate a Razorpay checkout for a subscription plan."
    - "Successful payments update user to 'premium' status locally and natively."
  artifacts:
    - "lib/presentation/screens/profile/subscription_screen.dart"
    - "lib/domain/services/payment_service.dart"
---

# Plan 4.1: Subscriptions UI & Razorpay

<objective>
To build the Razorpay integration and Subscription Screen enabling users to purchase premium features bridging payment gateway tokens safely.

Purpose: Essential revenue model mapping free/paid gates.
Output: A functional subscription flow with mocked local logic until live keys are active.
</objective>

<context>
Load for context:
- fitkarma/lib/data/providers/auth_provider.dart
- fitkarma/pubspec.yaml (razorpay_flutter dependency)
</context>

<tasks>

<task type="auto">
  <name>Construct Payment Service</name>
  <files>lib/domain/services/payment_service.dart, lib/data/providers/subscription_provider.dart</files>
  <action>
    - Create `PaymentService` wrapping `Razorpay` explicitly initializing event listeners for success, error, and external wallets.
    - Write a Riverpod `subscriptionProvider` triggering the checkout process and updating global `UserModel.isPremium` flags upon a valid transaction.
    - Avoid hardcoding real keys, instead use test environments resolving natively.
  </action>
  <verify>Riverpod safely resolves the Razorpay library without crashing natively.</verify>
  <done>Payments logic resolves triggers updating local states perfectly.</done>
</task>

<task type="auto">
  <name>Build Subscription Screen</name>
  <files>lib/presentation/screens/profile/subscription_screen.dart</files>
  <action>
    - Create UI displaying Free, Monthly, Quarterly, and Yearly plans using native Riverpod states.
    - Hook the 'Upgrade' buttons explicitly to the `subscriptionProvider` launching the Razorpay gateway.
    - Lock premium UI elements (like ad-free indicators or advanced features) behind the `isPremium` boolean resolving through `authProvider`.
  </action>
  <verify>Compilation passes and subscription buttons launch the gateway interfaces natively.</verify>
  <done>Tiered UI maps smoothly handling gateways without failing null assertions.</done>
</task>

</tasks>

<verification>
After all tasks, verify:
- [ ] Subscriptions trigger checkout securely updating Auth models smoothly offline.
</verification>

<success_criteria>
- [ ] All tasks verified
- [ ] Must-haves confirmed
</success_criteria>
