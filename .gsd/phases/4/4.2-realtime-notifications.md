---
phase: 4
plan: 2
wave: 2
depends_on: [1]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "PocketBase SSE connections stream real-time updates directly into the app state."
    - "Snackbars or toasts trigger effortlessly on incoming webhook/database changes."
  artifacts:
    - "lib/core/sync/notification_service.dart"
---

# Plan 4.2: Real-Time Notifications

<objective>
To implement a persistent Server-Sent Events (SSE) listener via PocketBase client resolving push-like notifications directly in-app globally.

Purpose: Engage users instantly with updates (workouts, karma) directly over WebSocket equivalents.
Output: Background active streams presenting Snackbars tracking real-time events.
</objective>

<context>
Load for context:
- fitkarma/lib/data/providers/pocketbase_client.dart
- fitkarma/lib/shared/widgets/app_shell.dart
</context>

<tasks>

<task type="auto">
  <name>Configure Notification Service</name>
  <files>lib/core/sync/notification_service.dart, lib/main.dart</files>
  <action>
    - Develop a `NotificationService` linking explicitly to `pb.collection('notifications').subscribe('*', ...)` listening for events.
    - Initialize this stream silently mapping inputs into native `Flutter` streams.
    - Prevent connection memory leaks tracking subscriptions carefully removing them actively on logout.
  </action>
  <verify>Service instances initialize connection strings successfully listening effectively.</verify>
  <done>Global subscriptions route seamlessly passing objects through streams.</done>
</task>

<task type="auto">
  <name>UI Subscription Handlers</name>
  <files>lib/shared/widgets/app_shell.dart</files>
  <action>
    - Hook Riverpod to listen to the `NotificationStream` inside the `AppShell` effectively providing app-wide popups.
    - Use `ScaffoldMessenger` rendering floating alerts asynchronously without disrupting the UI layer.
  </action>
  <verify>Pushing test objects explicitly triggers Snackbars safely resolving natively.</verify>
  <done>Users receive real-time alerts seamlessly rendering properly.</done>
</task>

</tasks>

<verification>
After all tasks, verify:
- [ ] Subscribing to PocketBase tables correctly listens reflecting alerts without crashing natively.
</verification>

<success_criteria>
- [ ] All tasks verified
- [ ] Must-haves confirmed
</success_criteria>
