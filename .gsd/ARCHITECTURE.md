# Architecture

> Auto-generated by /map on 2026-02-24

## Overview

FitKarma is an Indian fitness application designed with a culture-first, offline-ready approach. It leverages Flutter for the cross-platform UI and PocketBase as a lightweight, real-time backend. The architecture follows a clean, layered approach with a heavy emphasis on local persistence using Hive.

```
┌─────────────────────────────────────────┐
│              [App Entry]                │
│             (lib/main.dart)             │
├─────────────────────────────────────────┤
│          [Presentation Layer]           │
│  (UI Widgets, Screens, GoRouter Navigation) │
├─────────────────────────────────────────┤
│          [Application Layer]            │
│  (Riverpod Notifiers, State Providers)  │
├─────────────────────────────────────────┤
│            [Domain Layer]               │
│  (Business Logic, Services - STT, OCR)  │
├─────────────────────────────────────────┤
│              [Data Layer]               │
│ (Repositories, Models, Hive, PocketBase)│
└─────────────────────────────────────────┘
```

## Components

### 1. Presentation Layer
- **Purpose:** Handles the user interface and navigation.
- **Location:** `lib/presentation/`
- **Key Modules:**
  - `screens/`: Feature-specific pages (Dashboard, Food Logging, Dosha Quiz, etc.)
  - `widgets/`: Reusable UI components (BottomNavBar, VoiceAssistantSheet).
  - `theme/`: Styling tokens (Saffron/Mint palette).

### 2. Application Layer (State Management)
- **Purpose:** Manages app state and business logic flow using Riverpod.
- **Location:** `lib/data/providers/`
- **Key Providers:**
  - `auth_provider.dart`: Authentication state.
  - `food_provider.dart`: Meal logging and search.
  - `step_provider.dart`: Real-time pedometer stream.
  - `meal_provider.dart`: AI meal planner state.
  - `locale_provider.dart`: Internationalization state.

### 3. Data Layer
- **Purpose:** Handles data retrieval and persistence.
- **Location:** `lib/data/`
- **Modules:**
  - `models/`: Type-safe data structures with Hive annotations for persistence.
  - `repositories/`: Abstracted data fetching logic (FoodRepository, MealRepository).
  - `storage/`: Hive service for local-first storage.

### 4. Core & Integration
- **Purpose:** Common utilities and third-party service gateways.
- **Location:** `lib/core/`
- **Key Modules:**
  - `sync/`: Background sync logic between Hive and PocketBase.
  - `utils/`: Voice services, router configuration.
  - `network/`: PocketBase client configuration.

## Data Flow

1. **User Interaction**: User triggers an action in the UI (e.g., logging a meal via voice).
2. **Intent Parsing**: `VoiceService` parses English/Hindi speech into a structured intent.
3. **Provider Update**: The UI triggers a Riverpod provider (e.g., `foodProvider`).
4. **Local Persistence**: Data is first written to a **Hive box** for instant offline feedback.
5. **Background Sync**: `SyncService` detects the change and attempts to push the record to the **PocketBase backend** when connectivity is available.

## Integration Points

| Service | Type | Purpose |
|---------|------|---------|
| PocketBase | Backend | Real-time DB, Auth, SSE Notifications |
| Razorpay | Payment | Subscription management |
| Mixpanel | Analytics | User behavioral tracking |
| Sentry | Errors | Crash reporting & telemetry |
| STT/TTS | Native | Voice-first interaction (EN-IN/HI-IN) |

## Technical Debt

- [ ] Upgrade `encryptedSharedPreferences` to new Jetpack Security standards as requested by lints.
- [ ] Refactor `withOpacity` to `withValues` across the entire `lib/presentation` directory (30+ instances remaining).
- [ ] Migrate `VoiceService` intent parser to a more robust NLP module (currently regex-based).

## Conventions

**Naming:** PascalCase for Classes, camelCase for variables/methods, snake_case for filenames.
**Structure:** Layered directory structure (Data/Presentation/Core).
**Testing:** Primarily focus on widget and unit tests in `test/` (current coverage is low).
